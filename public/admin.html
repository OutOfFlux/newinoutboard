<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin — In/Out Board</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Big+Shoulders+Display:wght@700;800;900&family=Instrument+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --navy:        #0D2B52;
      --navy-mid:    #1A3D6E;
      --navy-light:  #E8EFF8;
      --amber:       #F5A623;
      --amber-dark:  #C47B0A;
      --amber-light: #FFF4DC;
      --slate:       #5A6E82;
      --mid-gray:    #8896A7;
      --light-gray:  #E2E8F0;
      --cream:       #F4EFE6;
      --dark:        #0F1923;
      --white:       #FFFFFF;
      --alert:       #C0392B;
      --success:     #2A7D4F;

      --bg-page:            var(--cream);
      --bg-card:            var(--white);
      --bg-header-main:     var(--navy);
      --bg-header:          var(--navy-light);
      --bg-hover:           #EEF3FA;
      --bg-editable-hover:  #E8EFF8;
      --bg-input:           var(--white);
      --text-primary:       var(--dark);
      --text-secondary:     var(--slate);
      --text-muted:         var(--mid-gray);
      --border-main:        var(--light-gray);
      --border-light:       #EDF1F7;
      --border-input:       #B8C8D8;
      --shadow:             rgba(13,43,82,0.09);
      --shadow-lg:          rgba(13,43,82,0.18);
      --link-color:         var(--amber-dark);
      --focus-border:       var(--amber);
      --accent:             var(--amber);

      --badge-green-bg:     #E6F7EE;
      --badge-green-text:   var(--success);
      --badge-yellow-bg:    var(--amber-light);
      --badge-yellow-text:  var(--amber-dark);
      --badge-red-bg:       #FEE8E6;
      --badge-red-text:     var(--alert);
      --row-red-hover:      #FAE3E0;
    }

    [data-theme="dark"] {
      --bg-page:            #060c18;
      --bg-card:            #0b1525;
      --bg-header-main:     #071630;
      --bg-header:          #091220;
      --bg-hover:           #122030;
      --bg-editable-hover:  #162840;
      --bg-input:           #0e1a2e;
      --text-primary:       #c8d9ec;
      --text-secondary:     #5A6E82;
      --text-muted:         #344d66;
      --border-main:        #162840;
      --border-light:       #0f1e32;
      --border-input:       #1a3254;
      --shadow:             rgba(0,0,0,0.5);
      --shadow-lg:          rgba(0,0,0,0.65);
      --link-color:         var(--amber);
      --focus-border:       var(--amber);
      --accent:             var(--amber);

      --badge-green-bg:     #010f09;
      --badge-green-text:   #10b981;
      --badge-yellow-bg:    #0c0700;
      --badge-yellow-text:  var(--amber);
      --badge-red-bg:       #0c0101;
      --badge-red-text:     #f87171;
      --row-red-hover:      #130202;
    }

    [data-theme="dark"] {
      background-image: radial-gradient(circle, rgba(22,40,64,0.4) 1px, transparent 1px);
      background-size: 22px 22px;
    }

    body {
      font-family: 'Instrument Sans', sans-serif;
      background: var(--bg-page);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* ── App header ── */
    .app-header {
      background: var(--bg-header-main);
      border-bottom: 2px solid var(--accent);
      box-shadow: 0 2px 16px rgba(0,0,0,0.35);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-inner {
      max-width: 900px;
      margin: 0 auto;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .header-logo {
      max-height: 34px;
      max-width: 100px;
      object-fit: contain;
    }

    .header-title {
      font-family: 'Big Shoulders Display', sans-serif;
      font-size: 1.35rem;
      font-weight: 700;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      flex: 1;
      white-space: nowrap;
      color: #ffffff;
    }

    .header-title span {
      font-family: 'Instrument Sans', sans-serif;
      font-size: 0.65rem;
      font-weight: 400;
      color: var(--accent);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      display: block;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .header-link {
      color: rgba(200,220,240,0.8);
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: 500;
      letter-spacing: 0.03em;
      padding: 4px 8px;
      border-radius: 3px;
      transition: color 0.15s, background 0.15s;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }

    .header-link:hover {
      color: #fff;
      background: rgba(255,255,255,0.14);
    }

    .header-link.logout-btn {
      background: none;
      border: 1px solid rgba(255,255,255,0.12);
      cursor: pointer;
      font-family: 'Instrument Sans', sans-serif;
      font-size: 0.8rem;
    }

    /* Dark mode toggle */
    .dark-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      color: rgba(200,220,240,0.7);
      user-select: none;
    }

    .dark-toggle-track {
      width: 36px;
      height: 20px;
      border-radius: 10px;
      background: rgba(255,255,255,0.18);
      position: relative;
      transition: background 0.2s;
    }

    .dark-toggle-track .thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #fff;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.2s;
    }

    [data-theme="dark"] .dark-toggle-track { background: var(--accent); }
    [data-theme="dark"] .dark-toggle-track .thumb { transform: translateX(16px); }

    /* ── Page container ── */
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 20px;
    }

    /* ── Section label ── */
    .section-label {
      font-family: 'Big Shoulders Display', sans-serif;
      font-size: 0.78rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-secondary);
      border-left: 3px solid var(--accent);
      padding-left: 8px;
      margin-bottom: 12px;
    }

    /* ── Cards / form panels ── */
    .panel {
      background: var(--bg-card);
      border-radius: 6px;
      border: 1px solid var(--border-main);
      box-shadow: 0 1px 4px var(--shadow);
      margin-bottom: 24px;
      overflow: hidden;
    }

    .panel-head {
      padding: 14px 20px 12px;
      border-bottom: 1px solid var(--border-main);
      background: var(--bg-header);
    }

    .panel-head h2 {
      font-family: 'Big Shoulders Display', sans-serif;
      font-size: 0.95rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--navy);
    }

    [data-theme="dark"] .panel-head h2 { color: var(--accent); }

    .panel-body { padding: 20px; }

    /* ── Form rows ── */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 160px;
    }

    .form-group label {
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .form-group input,
    .form-group select {
      padding: 8px 12px;
      border: 1px solid var(--border-input);
      border-radius: 4px;
      font-size: 0.875rem;
      font-family: 'Instrument Sans', sans-serif;
      background: var(--bg-input);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: var(--focus-border);
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--focus-border) 20%, transparent);
    }

    /* ── Buttons ── */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 7px 16px;
      border-radius: 4px;
      font-family: 'Instrument Sans', sans-serif;
      font-size: 0.83rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      border: none;
      transition: background 0.15s, opacity 0.15s, transform 0.1s;
      white-space: nowrap;
    }

    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; }

    .btn-primary { background: var(--amber); color: var(--navy); }
    .btn-primary:hover:not(:disabled) { background: var(--amber-dark); color: #fff; }

    .btn-danger {
      background: var(--badge-red-bg);
      color: var(--badge-red-text);
      border: 1px solid color-mix(in srgb, var(--badge-red-text) 25%, transparent);
    }
    .btn-danger:hover:not(:disabled) { background: var(--row-red-hover); }

    .btn-ghost {
      background: var(--bg-editable-hover);
      color: var(--text-primary);
      border: 1px solid var(--border-main);
    }
    .btn-ghost:hover:not(:disabled) { background: var(--border-main); }

    .btn-sm { padding: 4px 10px; font-size: 0.78rem; }

    /* ── Tables ── */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    thead th {
      text-align: left;
      padding: 10px 14px;
      background: var(--bg-header);
      border-bottom: 2px solid var(--border-main);
      font-family: 'Big Shoulders Display', sans-serif;
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--navy);
      white-space: nowrap;
    }

    [data-theme="dark"] thead th { color: var(--text-secondary); }

    tbody td {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border-light);
      vertical-align: middle;
    }

    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: var(--bg-hover); }

    .actions-cell {
      display: flex;
      gap: 6px;
      flex-wrap: nowrap;
    }

    /* ── Inline edit ── */
    td input[type="text"],
    td select {
      width: 100%;
      padding: 4px 8px;
      border: 2px solid var(--focus-border);
      border-radius: 4px;
      font-size: 0.875rem;
      font-family: 'Instrument Sans', sans-serif;
      outline: none;
      background: var(--bg-input);
      color: var(--text-primary);
    }

    /* ── Badges ── */
    .badge {
      display: inline-block;
      padding: 2px 9px;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
      letter-spacing: 0.02em;
    }

    .badge.green  { background: var(--badge-green-bg);  color: var(--badge-green-text); }
    .badge.yellow { background: var(--badge-yellow-bg); color: var(--badge-yellow-text); }
    .badge.red    { background: var(--badge-red-bg);    color: var(--badge-red-text); }

    /* ── Employee count ── */
    .emp-count {
      font-family: 'Instrument Sans', sans-serif;
      font-size: 0.8rem;
      font-weight: 400;
      color: var(--text-secondary);
      letter-spacing: 0;
    }

    /* ── Toast ── */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 11px 18px;
      background: var(--navy);
      color: #fff;
      border-left: 3px solid var(--accent);
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 500;
      box-shadow: 0 4px 16px var(--shadow-lg);
      transform: translateY(80px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.error { background: var(--alert); border-left-color: #fff; }

    /* ── Confirm overlay ── */
    .confirm-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(13,43,82,0.45);
      z-index: 999;
      align-items: center;
      justify-content: center;
    }

    .confirm-overlay.show { display: flex; }

    .confirm-dialog {
      background: var(--bg-card);
      border-radius: 6px;
      border-top: 3px solid var(--accent);
      box-shadow: 0 8px 32px var(--shadow-lg);
      padding: 24px;
      max-width: 400px;
      width: 90%;
    }

    .confirm-dialog h3 {
      font-family: 'Big Shoulders Display', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--navy);
      margin-bottom: 8px;
    }

    [data-theme="dark"] .confirm-dialog h3 { color: var(--accent); }

    .confirm-dialog p {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .confirm-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* ── Footer ── */
    .page-footer {
      text-align: center;
      padding: 24px 0 12px;
      font-size: 0.72rem;
      color: var(--text-muted);
      letter-spacing: 0.04em;
    }

    /* ── Danger Zone ── */
    .danger-zone {
      border: 1px solid #F5A49A;
      border-radius: 6px;
      margin-bottom: 24px;
      overflow: hidden;
    }

    .danger-zone-header {
      background: #FEF2F2;
      padding: 11px 20px;
      border-bottom: 1px solid #F5A49A;
    }

    [data-theme="dark"] .danger-zone-header {
      background: #1a0505;
      border-bottom-color: #4a0e0e;
    }

    .danger-zone-header h2 {
      font-family: 'Big Shoulders Display', sans-serif;
      font-size: 0.78rem;
      font-weight: 700;
      color: var(--alert);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    [data-theme="dark"] .danger-zone-header h2 { color: #f87171; }

    .danger-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border-light);
      background: var(--bg-card);
      flex-wrap: wrap;
    }

    .danger-item:last-child { border-bottom: none; }

    .danger-item-info { flex: 1; min-width: 180px; }

    .danger-item-info strong {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .danger-item-info span {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .btn-danger-solid {
      background: var(--alert);
      color: #fff;
      padding: 6px 14px;
      border-radius: 4px;
      border: none;
      font-size: 0.78rem;
      font-weight: 600;
      font-family: 'Instrument Sans', sans-serif;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.15s;
    }

    .btn-danger-solid:hover { background: #922B21; }

    /* Danger confirm input */
    .danger-confirm-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-input);
      border-radius: 4px;
      font-size: 0.875rem;
      font-family: 'Instrument Sans', sans-serif;
      margin: 12px 0 16px;
      background: var(--bg-input);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.15s;
    }

    .danger-confirm-input:focus {
      border-color: var(--alert);
      box-shadow: 0 0 0 2px rgba(192,57,43,0.15);
    }

    /* Mobile */
    @media (max-width: 640px) {
      .container { padding: 14px 12px; }
      .form-group { min-width: 100%; }
      thead th, tbody td { padding: 8px 8px; }
      .col-status { display: none; }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="header-inner">
      <img src="/images/logo.png" alt="CCPPD Logo" class="header-logo" onerror="this.style.display='none'">
      <div class="header-title">
        Admin
        <span>In/Out Board</span>
      </div>
      <div class="header-actions">
        <label class="dark-toggle" id="darkToggle">
          <span class="dark-toggle-track"><span class="thumb"></span></span>
          <span>Dark</span>
        </label>
        <a href="/" class="header-link">&larr; Board</a>
        <form method="POST" action="/admin/logout" style="display:inline;">
          <button type="submit" class="header-link logout-btn">Logout</button>
        </form>
      </div>
    </div>
  </header>

  <div class="container">

    <!-- Logo -->
    <div class="section-label">Logo</div>
    <div class="panel" style="margin-bottom:24px;">
      <div class="panel-body">
        <div style="display:flex; gap:24px; align-items:flex-start; flex-wrap:wrap;">
          <div>
            <img id="logoPreview" src="/images/logo.png" alt="Current logo"
              style="display:block; max-height:80px; max-width:160px; width:auto; height:auto; object-fit:contain; border:1px solid var(--border-main); border-radius:4px; padding:6px; background:var(--bg-page);">
            <p style="font-size:0.7rem; color:var(--text-muted); margin-top:4px; text-align:center; letter-spacing:0.04em;">Current logo</p>
          </div>
          <div style="flex:1; min-width:260px;">
            <div class="form-group" style="margin-bottom:10px;">
              <label for="logoFile">Replace Logo</label>
              <input type="file" id="logoFile" accept="image/png,image/jpeg,image/gif,image/webp"
                style="padding:4px 0; color:var(--text-primary);">
            </div>
            <p style="font-size:0.78rem; color:var(--text-secondary); line-height:1.6; margin-bottom:12px;">
              <strong>Ideal size:</strong> 160&times;160 px or wider (displayed up to 160&times;80 px; 2&times; for sharp screens)<br>
              <strong>Format:</strong> PNG with transparent background recommended<br>
              <strong>Accepted:</strong> PNG, JPG, GIF, WebP &nbsp;&middot;&nbsp; <strong>Max size:</strong> 2 MB
            </p>
            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
              <button id="logoUploadBtn" class="btn btn-primary" disabled>Upload Logo</button>
              <span id="logoUploadMsg" style="font-size:0.78rem; color:var(--text-secondary);"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Employee -->
    <div class="section-label">Employees</div>
    <div class="panel">
      <div class="panel-head">
        <h2>Add Employee</h2>
      </div>
      <div class="panel-body">
        <form id="addForm" class="form-row">
          <div class="form-group">
            <label for="addName">Name</label>
            <input type="text" id="addName" placeholder="Jane Doe" required maxlength="100">
          </div>
          <div class="form-group">
            <label for="addDept">Department</label>
            <select id="addDept" required></select>
          </div>
          <div class="form-group" style="flex:0; min-width:auto;">
            <label>&nbsp;</label>
            <button type="submit" class="btn btn-primary">Add Employee</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Employee List -->
    <div class="panel">
      <div class="panel-head">
        <h2>Employees <span class="emp-count" id="empCount"></span></h2>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Department</th>
              <th class="col-status">Status</th>
              <th style="width:1%"></th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Add Vehicle -->
    <div class="section-label">Vehicles</div>
    <div class="panel">
      <div class="panel-head">
        <h2>Add Vehicle</h2>
      </div>
      <div class="panel-body">
        <form id="addVehicleForm" class="form-row">
          <div class="form-group">
            <label for="addVehicleName">Vehicle Name</label>
            <input type="text" id="addVehicleName" placeholder="2022 Ford F-150" required maxlength="100">
          </div>
          <div class="form-group" style="flex:0; min-width:auto;">
            <label>&nbsp;</label>
            <button type="submit" class="btn btn-primary">Add Vehicle</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Vehicle List -->
    <div class="panel">
      <div class="panel-head">
        <h2>Vehicles <span class="emp-count" id="vehicleCount"></span></h2>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Vehicle Name</th>
              <th>Status</th>
              <th style="width:1%"></th>
            </tr>
          </thead>
          <tbody id="vehicleTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Add Department -->
    <div class="section-label">Departments</div>
    <div class="panel">
      <div class="panel-head">
        <h2>Add Department</h2>
      </div>
      <div class="panel-body">
        <form id="addDeptForm" class="form-row">
          <div class="form-group">
            <label for="addDeptName">Department Name</label>
            <input type="text" id="addDeptName" placeholder="Engineering" required maxlength="100">
          </div>
          <div class="form-group" style="flex:0; min-width:auto;">
            <label>&nbsp;</label>
            <button type="submit" class="btn btn-primary">Add Department</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Department List -->
    <div class="panel">
      <div class="panel-head">
        <h2>Departments <span class="emp-count" id="deptCount"></span></h2>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Employees</th>
              <th style="width:1%"></th>
            </tr>
          </thead>
          <tbody id="deptTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Danger Zone -->
    <div class="danger-zone">
      <div class="danger-zone-header">
        <h2>Danger Zone</h2>
      </div>
      <div class="danger-item">
        <div class="danger-item-info">
          <strong>Remove all employees</strong>
          <span>Permanently delete every employee record from the board.</span>
        </div>
        <button class="btn-danger-solid" id="removeAllEmployeesBtn">Remove all employees</button>
      </div>
      <div class="danger-item">
        <div class="danger-item-info">
          <strong>Remove all vehicles</strong>
          <span>Permanently delete every vehicle and clear all vehicle assignments.</span>
        </div>
        <button class="btn-danger-solid" id="removeAllVehiclesBtn">Remove all vehicles</button>
      </div>
      <div class="danger-item">
        <div class="danger-item-info">
          <strong>Remove all departments</strong>
          <span>Permanently delete every department. Employees will keep their department label.</span>
        </div>
        <button class="btn-danger-solid" id="removeAllDeptsBtn">Remove all departments</button>
      </div>
    </div>

  </div>

  <!-- Delete confirmation dialog -->
  <div class="confirm-overlay" id="confirmOverlay">
    <div class="confirm-dialog">
      <h3 id="confirmTitle">Confirm Remove</h3>
      <p id="confirmMsg">Are you sure you want to remove this employee?</p>
      <div class="confirm-actions">
        <button class="btn btn-ghost" id="confirmCancel">Cancel</button>
        <button class="btn btn-danger" id="confirmDelete">Remove</button>
      </div>
    </div>
  </div>

  <!-- Danger Zone confirmation dialog -->
  <div class="confirm-overlay" id="dangerOverlay">
    <div class="confirm-dialog">
      <h3 id="dangerTitle"></h3>
      <p id="dangerMsg"></p>
      <input type="text" class="danger-confirm-input" id="dangerInput" placeholder='Type REMOVE to confirm' autocomplete="off">
      <div class="confirm-actions">
        <button class="btn btn-ghost" id="dangerCancel">Cancel</button>
        <button class="btn btn-danger" id="dangerConfirmBtn" disabled>Remove</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <footer class="page-footer">In/Out Board v<span id="footerVersion"></span></footer>

  <script>
    // --- Footer version ---
    fetch('/version').then(r => r.json()).then(({ version }) => {
      document.getElementById('footerVersion').textContent = version;
    });

    // --- Dark mode (shared with main board via localStorage) ---
    function applyTheme(dark) {
      document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
      localStorage.setItem('theme', dark ? 'dark' : 'light');
    }

    const darkToggle = document.getElementById('darkToggle');
    darkToggle.addEventListener('click', () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      applyTheme(!isDark);
    });

    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      applyTheme(savedTheme === 'dark');
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      applyTheme(true);
    }

    const GREEN_STATUSES = ['IN'];
    const YELLOW_STATUSES = ['In Meeting', 'On Break', 'At Lunch', 'Away from Desk'];
    const RED_STATUSES = ['OUT', 'Working Remotely', 'PTO', 'Sick'];

    function statusColor(status) {
      if (GREEN_STATUSES.includes(status)) return 'green';
      if (YELLOW_STATUSES.includes(status)) return 'yellow';
      return 'red';
    }

    // --- Helpers ---
    function sortVehicles(a, b) {
      const aTruck = /^T\d/i.test(a.name);
      const bTruck = /^T\d/i.test(b.name);
      if (aTruck !== bTruck) return aTruck ? 1 : -1;
      if (aTruck) return parseInt(a.name.slice(1)) - parseInt(b.name.slice(1));
      return a.name.localeCompare(b.name);
    }

    // --- State ---
    let employees = [];
    let vehicles = [];
    let departments = [];
    let editingId = null; // currently editing employee row
    let editingVehicleId = null; // currently editing vehicle row
    let editingDeptId = null; // currently editing department row
    let deletingId = null; // pending delete (employee)
    let deletingVehicleId = null; // pending delete (vehicle)
    let deletingDeptId = null; // pending delete (department)

    // --- DOM ---
    const tableBody = document.getElementById('tableBody');
    const empCount = document.getElementById('empCount');
    const addForm = document.getElementById('addForm');
    const addName = document.getElementById('addName');
    const addDept = document.getElementById('addDept');
    const vehicleTableBody = document.getElementById('vehicleTableBody');
    const vehicleCount = document.getElementById('vehicleCount');
    const addVehicleForm = document.getElementById('addVehicleForm');
    const addVehicleName = document.getElementById('addVehicleName');
    const addDeptForm = document.getElementById('addDeptForm');
    const addDeptName = document.getElementById('addDeptName');
    const deptTableBody = document.getElementById('deptTableBody');
    const deptCount = document.getElementById('deptCount');
    const confirmTitle = document.getElementById('confirmTitle');
    const confirmOverlay = document.getElementById('confirmOverlay');
    const confirmMsg = document.getElementById('confirmMsg');
    const confirmCancel = document.getElementById('confirmCancel');
    const confirmDelete = document.getElementById('confirmDelete');
    const toast = document.getElementById('toast');

    // --- Toast ---
    let toastTimer = null;
    function showToast(msg, isError = false) {
      clearTimeout(toastTimer);
      toast.textContent = msg;
      toast.className = 'toast' + (isError ? ' error' : '');
      requestAnimationFrame(() => toast.classList.add('show'));
      toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // --- WebSocket ---
    function connectWs() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws = new WebSocket(`${protocol}//${location.host}`);

      ws.addEventListener('open', () => {});

      ws.addEventListener('close', () => {
        setTimeout(connectWs, 2000);
      });

      ws.addEventListener('message', (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'init') {
          employees = data.employees;
          vehicles = data.vehicles || [];
          departments = data.departments || [];
          refreshAddDeptSelect();
          render();
          renderVehicles();
          renderDepartments();
        } else if (data.type === 'employee_updated') {
          const idx = employees.findIndex(e => e.id === data.employee.id);
          if (idx !== -1) employees[idx] = data.employee;
          render();
          renderVehicles();
          renderDepartments();
        } else if (data.type === 'employee_added') {
          employees.push(data.employee);
          employees.sort((a, b) => a.name.localeCompare(b.name));
          render();
          renderDepartments();
        } else if (data.type === 'employee_removed') {
          employees = employees.filter(e => e.id !== data.id);
          render();
          renderVehicles();
          renderDepartments();
        } else if (data.type === 'vehicle_added') {
          vehicles.push(data.vehicle);
          vehicles.sort(sortVehicles);
          renderVehicles();
        } else if (data.type === 'vehicle_updated') {
          const idx = vehicles.findIndex(v => v.id === data.vehicle.id);
          if (idx !== -1) vehicles[idx] = data.vehicle;
          renderVehicles();
        } else if (data.type === 'vehicle_removed') {
          vehicles = vehicles.filter(v => v.id !== data.id);
          renderVehicles();
        } else if (data.type === 'department_added') {
          departments.push(data.department);
          departments.sort((a, b) => a.name.localeCompare(b.name));
          refreshAddDeptSelect();
          renderDepartments();
        } else if (data.type === 'department_updated') {
          const idx = departments.findIndex(d => d.id === data.department.id);
          if (idx !== -1) departments[idx] = data.department;
          departments.sort((a, b) => a.name.localeCompare(b.name));
          refreshAddDeptSelect();
          renderDepartments();
        } else if (data.type === 'department_removed') {
          departments = departments.filter(d => d.id !== data.id);
          refreshAddDeptSelect();
          renderDepartments();
        }
      });
    }

    connectWs();

    // --- API ---
    async function apiPost(url, body) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function apiPut(url, body) {
      const res = await fetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function apiDelete(url) {
      const res = await fetch(url, { method: 'DELETE' });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    // --- Rebuild the Add Employee department dropdown ---
    function refreshAddDeptSelect() {
      const current = addDept.value;
      addDept.innerHTML = '<option value="">— Select department —</option>';
      departments.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.name;
        opt.textContent = d.name;
        addDept.appendChild(opt);
      });
      if (current && departments.some(d => d.name === current)) addDept.value = current;
    }

    // --- Add employee ---
    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = addName.value.trim();
      const department = addDept.value.trim();
      if (!name || !department) return;

      try {
        await apiPost('/employees', { name, department });
        addName.value = '';
        addDept.value = '';
        addName.focus();
        showToast(`Added ${name}`);
      } catch (err) {
        showToast('Failed to add employee', true);
      }
    });

    // --- Add department ---
    addDeptForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = addDeptName.value.trim();
      if (!name) return;
      try {
        await apiPost('/departments', { name });
        addDeptName.value = '';
        addDeptName.focus();
        showToast(`Added department "${name}"`);
      } catch (err) {
        showToast('Failed to add department', true);
      }
    });

    // --- Add vehicle ---
    addVehicleForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = addVehicleName.value.trim();
      if (!name) return;

      try {
        await apiPost('/vehicles', { name });
        addVehicleName.value = '';
        addVehicleName.focus();
        showToast(`Added ${name}`);
      } catch (err) {
        showToast('Failed to add vehicle', true);
      }
    });

    // --- Delete flow ---
    function closeConfirm() {
      deletingId = null;
      deletingVehicleId = null;
      deletingDeptId = null;
      confirmOverlay.classList.remove('show');
    }

    confirmCancel.addEventListener('click', closeConfirm);
    confirmOverlay.addEventListener('click', (e) => { if (e.target === confirmOverlay) closeConfirm(); });

    confirmDelete.addEventListener('click', async () => {
      if (deletingDeptId) {
        const d = departments.find(d => d.id === deletingDeptId);
        try {
          await apiDelete(`/departments/${deletingDeptId}`);
          showToast(`Removed department "${d ? d.name : ''}"`);
        } catch (err) {
          showToast('Failed to remove department', true);
        }
        closeConfirm();
        return;
      }
      if (deletingVehicleId) {
        const v = vehicles.find(v => v.id === deletingVehicleId);
        try {
          await apiDelete(`/vehicles/${deletingVehicleId}`);
          showToast(`Removed ${v ? v.name : 'vehicle'}`);
        } catch (err) {
          showToast('Failed to remove vehicle', true);
        }
        closeConfirm();
        return;
      }
      if (!deletingId) return;
      const emp = employees.find(e => e.id === deletingId);
      try {
        await apiDelete(`/employees/${deletingId}`);
        showToast(`Removed ${emp ? emp.name : 'employee'}`);
      } catch (err) {
        showToast('Failed to remove employee', true);
      }
      closeConfirm();
    });

    function promptDelete(emp) {
      deletingId = emp.id;
      deletingVehicleId = null;
      deletingDeptId = null;
      confirmTitle.textContent = 'Remove Employee';
      confirmMsg.textContent = `Are you sure you want to remove ${emp.name} (${emp.department})?`;
      confirmOverlay.classList.add('show');
    }

    function promptDeleteVehicle(vehicle) {
      const usedBy = employees.find(e => e.vehicle_id === vehicle.id);
      deletingVehicleId = vehicle.id;
      deletingId = null;
      deletingDeptId = null;
      confirmTitle.textContent = 'Remove Vehicle';
      confirmMsg.textContent = usedBy
        ? `Remove "${vehicle.name}"? It is currently checked out by ${usedBy.name}.`
        : `Are you sure you want to remove "${vehicle.name}"?`;
      confirmOverlay.classList.add('show');
    }

    function promptDeleteDept(dept) {
      const count = employees.filter(e => e.department === dept.name).length;
      deletingDeptId = dept.id;
      deletingId = null;
      deletingVehicleId = null;
      confirmTitle.textContent = 'Remove Department';
      confirmMsg.textContent = count > 0
        ? `Remove "${dept.name}"? ${count} employee${count !== 1 ? 's' : ''} currently use this department. They will keep their department label.`
        : `Are you sure you want to remove "${dept.name}"?`;
      confirmOverlay.classList.add('show');
    }

    // --- Inline edit ---
    function startEditing(id) {
      editingId = id;
      render();
    }

    async function saveEdit(id) {
      const row = document.querySelector(`tr[data-id="${id}"]`);
      if (!row) return;

      const nameInput = row.querySelector('.edit-name');
      const deptInput = row.querySelector('.edit-dept');
      if (!nameInput || !deptInput) return;

      const name = nameInput.value.trim();
      const department = deptInput.value.trim();

      if (!name || !department) {
        showToast('Name and department cannot be empty', true);
        return;
      }

      try {
        await apiPut(`/employees/${id}`, { name, department });
        showToast('Saved changes');
      } catch (err) {
        showToast('Failed to save', true);
      }

      editingId = null;
      render();
    }

    function cancelEdit() {
      editingId = null;
      render();
    }

    function startEditingVehicle(id) {
      editingVehicleId = id;
      renderVehicles();
    }

    async function saveVehicleEdit(id) {
      const row = document.querySelector(`tr[data-vehicle-id="${id}"]`);
      if (!row) return;
      const nameInput = row.querySelector('.edit-vehicle-name');
      if (!nameInput) return;
      const name = nameInput.value.trim();
      if (!name) {
        showToast('Vehicle name cannot be empty', true);
        return;
      }
      try {
        await apiPut(`/vehicles/${id}`, { name });
        showToast('Saved changes');
      } catch (err) {
        showToast('Failed to save', true);
      }
      editingVehicleId = null;
      renderVehicles();
    }

    function cancelVehicleEdit() {
      editingVehicleId = null;
      renderVehicles();
    }

    // --- Render vehicles ---
    function renderVehicles() {
      vehicleCount.textContent = `(${vehicles.length})`;
      vehicleTableBody.innerHTML = '';

      vehicles.forEach(vehicle => {
        const tr = document.createElement('tr');
        tr.dataset.vehicleId = vehicle.id;
        const isEditing = editingVehicleId === vehicle.id;

        // Name
        const tdName = document.createElement('td');
        if (isEditing) {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'edit-vehicle-name';
          input.maxLength = 100;
          input.value = vehicle.name;
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); saveVehicleEdit(vehicle.id); }
            if (e.key === 'Escape') cancelVehicleEdit();
          });
          tdName.appendChild(input);
        } else {
          tdName.textContent = vehicle.name;
        }
        tr.appendChild(tdName);

        // Status: Available or In Use
        const tdStatus = document.createElement('td');
        const usedBy = employees.find(e => e.vehicle_id === vehicle.id);
        const badge = document.createElement('span');
        if (usedBy) {
          badge.className = 'badge yellow';
          badge.textContent = `Out — ${usedBy.name}`;
        } else {
          badge.className = 'badge green';
          badge.textContent = 'Available';
        }
        tdStatus.appendChild(badge);
        tr.appendChild(tdStatus);

        // Actions
        const tdActions = document.createElement('td');
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'actions-cell';

        if (isEditing) {
          const saveBtn = document.createElement('button');
          saveBtn.className = 'btn btn-primary btn-sm';
          saveBtn.textContent = 'Save';
          saveBtn.addEventListener('click', () => saveVehicleEdit(vehicle.id));
          actionsDiv.appendChild(saveBtn);

          const cancelBtn = document.createElement('button');
          cancelBtn.className = 'btn btn-ghost btn-sm';
          cancelBtn.textContent = 'Cancel';
          cancelBtn.addEventListener('click', cancelVehicleEdit);
          actionsDiv.appendChild(cancelBtn);
        } else {
          const editBtn = document.createElement('button');
          editBtn.className = 'btn btn-ghost btn-sm';
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', () => startEditingVehicle(vehicle.id));
          actionsDiv.appendChild(editBtn);

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn-danger btn-sm';
          deleteBtn.textContent = 'Remove';
          deleteBtn.addEventListener('click', () => promptDeleteVehicle(vehicle));
          actionsDiv.appendChild(deleteBtn);
        }

        tdActions.appendChild(actionsDiv);
        tr.appendChild(tdActions);

        vehicleTableBody.appendChild(tr);
      });

      // Auto-focus first input in editing row
      if (editingVehicleId) {
        const firstInput = vehicleTableBody.querySelector(`tr[data-vehicle-id="${editingVehicleId}"] .edit-vehicle-name`);
        if (firstInput) { firstInput.focus(); firstInput.select(); }
      }
    }

    // --- Render ---
    function render() {
      empCount.textContent = `(${employees.length})`;

      tableBody.innerHTML = '';
      employees.forEach(emp => {
        const tr = document.createElement('tr');
        tr.dataset.id = emp.id;
        const isEditing = editingId === emp.id;

        // Name
        const tdName = document.createElement('td');
        if (isEditing) {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'edit-name';
          input.maxLength = 100;
          input.value = emp.name;
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); saveEdit(emp.id); }
            if (e.key === 'Escape') cancelEdit();
          });
          tdName.appendChild(input);
        } else {
          tdName.textContent = emp.name;
        }
        tr.appendChild(tdName);

        // Department
        const tdDept = document.createElement('td');
        if (isEditing) {
          const deptSel = document.createElement('select');
          deptSel.className = 'edit-dept';
          // Include current value even if not in departments list (legacy data)
          const deptOptions = departments.map(d => d.name);
          if (emp.department && !deptOptions.includes(emp.department)) deptOptions.unshift(emp.department);
          deptOptions.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            if (name === emp.department) opt.selected = true;
            deptSel.appendChild(opt);
          });
          deptSel.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); saveEdit(emp.id); }
            if (e.key === 'Escape') cancelEdit();
          });
          tdDept.appendChild(deptSel);
        } else {
          tdDept.textContent = emp.department;
        }
        tr.appendChild(tdDept);

        // Status (read-only badge)
        const tdStatus = document.createElement('td');
        tdStatus.className = 'col-status';
        const badge = document.createElement('span');
        badge.className = `badge ${statusColor(emp.status)}`;
        badge.textContent = emp.status;
        tdStatus.appendChild(badge);
        tr.appendChild(tdStatus);

        // Actions
        const tdActions = document.createElement('td');
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'actions-cell';

        if (isEditing) {
          const saveBtn = document.createElement('button');
          saveBtn.className = 'btn btn-primary btn-sm';
          saveBtn.textContent = 'Save';
          saveBtn.addEventListener('click', () => saveEdit(emp.id));
          actionsDiv.appendChild(saveBtn);

          const cancelBtn = document.createElement('button');
          cancelBtn.className = 'btn btn-ghost btn-sm';
          cancelBtn.textContent = 'Cancel';
          cancelBtn.addEventListener('click', cancelEdit);
          actionsDiv.appendChild(cancelBtn);
        } else {
          const editBtn = document.createElement('button');
          editBtn.className = 'btn btn-ghost btn-sm';
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', () => startEditing(emp.id));
          actionsDiv.appendChild(editBtn);

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn-danger btn-sm';
          deleteBtn.textContent = 'Remove';
          deleteBtn.addEventListener('click', () => promptDelete(emp));
          actionsDiv.appendChild(deleteBtn);
        }

        tdActions.appendChild(actionsDiv);
        tr.appendChild(tdActions);

        tableBody.appendChild(tr);
      });

      // Auto-focus first input in editing row
      if (editingId) {
        const firstInput = tableBody.querySelector(`tr[data-id="${editingId}"] .edit-name`);
        if (firstInput) { firstInput.focus(); firstInput.select(); }
      }
    }

    // --- Departments ---
    function startEditingDept(id) { editingDeptId = id; renderDepartments(); }
    function cancelDeptEdit() { editingDeptId = null; renderDepartments(); }

    async function saveDeptEdit(id) {
      const row = deptTableBody.querySelector(`tr[data-dept-id="${id}"]`);
      if (!row) return;
      const input = row.querySelector('.edit-dept-name');
      if (!input) return;
      const name = input.value.trim();
      if (!name) { showToast('Name cannot be empty', true); return; }
      try {
        await apiPut(`/departments/${id}`, { name });
        showToast(`Renamed to "${name}"`);
      } catch (err) {
        showToast('Failed to rename department', true);
      }
      editingDeptId = null;
    }

    function renderDepartments() {
      deptCount.textContent = `(${departments.length})`;
      deptTableBody.innerHTML = '';
      departments.forEach(dept => {
        const isEditing = editingDeptId === dept.id;
        const empCount = employees.filter(e => e.department === dept.name).length;
        const tr = document.createElement('tr');
        tr.dataset.deptId = dept.id;

        // Name
        const tdName = document.createElement('td');
        if (isEditing) {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'edit-dept-name';
          input.maxLength = 100;
          input.value = dept.name;
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); saveDeptEdit(dept.id); }
            if (e.key === 'Escape') cancelDeptEdit();
          });
          tdName.appendChild(input);
        } else {
          tdName.textContent = dept.name;
        }
        tr.appendChild(tdName);

        // Employee count
        const tdCount = document.createElement('td');
        const badge = document.createElement('span');
        badge.className = empCount > 0 ? 'badge yellow' : 'badge green';
        badge.textContent = empCount > 0 ? `${empCount} employee${empCount !== 1 ? 's' : ''}` : 'Empty';
        tdCount.appendChild(badge);
        tr.appendChild(tdCount);

        // Actions
        const tdActions = document.createElement('td');
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'actions-cell';
        if (isEditing) {
          const saveBtn = document.createElement('button');
          saveBtn.className = 'btn btn-primary btn-sm';
          saveBtn.textContent = 'Save';
          saveBtn.addEventListener('click', () => saveDeptEdit(dept.id));
          actionsDiv.appendChild(saveBtn);
          const cancelBtn = document.createElement('button');
          cancelBtn.className = 'btn btn-ghost btn-sm';
          cancelBtn.textContent = 'Cancel';
          cancelBtn.addEventListener('click', cancelDeptEdit);
          actionsDiv.appendChild(cancelBtn);
        } else {
          const editBtn = document.createElement('button');
          editBtn.className = 'btn btn-ghost btn-sm';
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', () => startEditingDept(dept.id));
          actionsDiv.appendChild(editBtn);
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn-danger btn-sm';
          deleteBtn.textContent = 'Remove';
          deleteBtn.addEventListener('click', () => promptDeleteDept(dept));
          actionsDiv.appendChild(deleteBtn);
        }
        tdActions.appendChild(actionsDiv);
        tr.appendChild(tdActions);

        deptTableBody.appendChild(tr);
      });

      if (editingDeptId) {
        const firstInput = deptTableBody.querySelector(`tr[data-dept-id="${editingDeptId}"] .edit-dept-name`);
        if (firstInput) { firstInput.focus(); firstInput.select(); }
      }
    }

    // --- Logo upload ---
    const logoFile = document.getElementById('logoFile');
    const logoPreview = document.getElementById('logoPreview');
    const logoUploadBtn = document.getElementById('logoUploadBtn');
    const logoUploadMsg = document.getElementById('logoUploadMsg');

    logoFile.addEventListener('change', () => {
      const file = logoFile.files[0];
      if (!file) { logoUploadBtn.disabled = true; logoUploadMsg.textContent = ''; return; }

      if (file.size > 2 * 1024 * 1024) {
        logoUploadMsg.textContent = 'File exceeds 2 MB limit.';
        logoUploadBtn.disabled = true;
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        logoPreview.src = e.target.result;
        logoUploadBtn.disabled = false;
        logoUploadMsg.textContent = '';
      };
      reader.readAsDataURL(file);
    });

    // --- Danger Zone ---
    let dangerAction = null;
    const dangerOverlay = document.getElementById('dangerOverlay');
    const dangerTitle = document.getElementById('dangerTitle');
    const dangerMsg = document.getElementById('dangerMsg');
    const dangerInput = document.getElementById('dangerInput');
    const dangerConfirmBtn = document.getElementById('dangerConfirmBtn');
    const dangerCancel = document.getElementById('dangerCancel');

    function openDangerConfirm(title, msg, action) {
      dangerAction = action;
      dangerTitle.textContent = title;
      dangerMsg.innerHTML = msg;
      dangerInput.value = '';
      dangerConfirmBtn.disabled = true;
      dangerOverlay.classList.add('show');
      setTimeout(() => dangerInput.focus(), 50);
    }

    function closeDangerConfirm() {
      dangerAction = null;
      dangerOverlay.classList.remove('show');
    }

    dangerInput.addEventListener('input', () => {
      dangerConfirmBtn.disabled = dangerInput.value.trim() !== 'REMOVE';
    });

    dangerInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeDangerConfirm();
      if (e.key === 'Enter' && !dangerConfirmBtn.disabled) dangerConfirmBtn.click();
    });

    dangerCancel.addEventListener('click', closeDangerConfirm);
    dangerOverlay.addEventListener('click', (e) => { if (e.target === dangerOverlay) closeDangerConfirm(); });

    dangerConfirmBtn.addEventListener('click', async () => {
      if (!dangerAction) return;
      const action = dangerAction;
      closeDangerConfirm();
      try {
        await action();
      } catch (err) {
        showToast('Operation failed', true);
      }
    });

    document.getElementById('removeAllEmployeesBtn').addEventListener('click', () => {
      openDangerConfirm(
        'Remove all employees',
        'This will permanently delete <strong>all employee records</strong>. This action cannot be undone.<br><br>Type <strong>REMOVE</strong> to confirm.',
        async () => {
          await apiDelete('/employees/all');
          showToast('All employees removed');
        }
      );
    });

    document.getElementById('removeAllVehiclesBtn').addEventListener('click', () => {
      openDangerConfirm(
        'Remove all vehicles',
        'This will permanently delete <strong>all vehicles</strong> and clear all vehicle assignments. This action cannot be undone.<br><br>Type <strong>REMOVE</strong> to confirm.',
        async () => {
          await apiDelete('/vehicles/all');
          showToast('All vehicles removed');
        }
      );
    });

    document.getElementById('removeAllDeptsBtn').addEventListener('click', () => {
      openDangerConfirm(
        'Remove all departments',
        'This will permanently delete <strong>all departments</strong>. Employees will keep their department label. This action cannot be undone.<br><br>Type <strong>REMOVE</strong> to confirm.',
        async () => {
          await apiDelete('/departments/all');
          showToast('All departments removed');
        }
      );
    });

    logoUploadBtn.addEventListener('click', () => {
      const file = logoFile.files[0];
      if (!file) return;

      logoUploadBtn.disabled = true;
      logoUploadMsg.textContent = 'Uploading…';

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const res = await fetch('/logo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: e.target.result }),
          });
          if (!res.ok) {
            const text = await res.text();
            let msg = 'Upload failed';
            try { msg = JSON.parse(text).error || msg; } catch (_) { /* non-JSON error body */ }
            throw new Error(msg);
          }
          // Cache-bust so the browser reloads the updated file
          logoPreview.src = `/images/logo.png?t=${Date.now()}`;
          logoFile.value = '';
          logoUploadMsg.textContent = 'Logo updated!';
          showToast('Logo updated successfully');
          setTimeout(() => { logoUploadMsg.textContent = ''; }, 3000);
        } catch (err) {
          logoUploadMsg.textContent = err.message;
          showToast(err.message, true);
        }
        logoUploadBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
