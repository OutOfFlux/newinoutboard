<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>In/Out Board</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Big+Shoulders+Display:wght@700;800;900&family=Instrument+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --navy:        #0D2B52;
      --navy-mid:    #1A3D6E;
      --navy-light:  #E8EFF8;
      --amber:       #F5A623;
      --amber-dark:  #C47B0A;
      --amber-light: #FFF4DC;
      --sky:         #4A7FAA;
      --slate:       #5A6E82;
      --mid-gray:    #8896A7;
      --light-gray:  #E2E8F0;
      --cream:       #F4EFE6;
      --dark:        #0F1923;
      --white:       #FFFFFF;
      --alert:       #C0392B;
      --success:     #2A7D4F;

      --bg-page:            var(--cream);
      --bg-card:            var(--white);
      --bg-header-main:     var(--navy);
      --bg-header:          var(--navy-light);
      --bg-header-hover:    #D4DFF0;
      --bg-hover:           #EEF3FA;
      --bg-editable-hover:  #E8EFF8;
      --bg-input:           var(--white);
      --text-primary:       var(--dark);
      --text-secondary:     var(--slate);
      --text-muted:         var(--mid-gray);
      --border-main:        var(--light-gray);
      --border-light:       #EDF1F7;
      --border-input:       #B8C8D8;
      --shadow:             rgba(13,43,82,0.09);
      --shadow-lg:          rgba(13,43,82,0.18);
      --separator:          var(--light-gray);
      --link-color:         var(--amber-dark);
      --focus-border:       var(--amber);
      --accent:             var(--amber);

      --badge-green-bg:     #E6F7EE;
      --badge-green-text:   var(--success);
      --badge-yellow-bg:    var(--amber-light);
      --badge-yellow-text:  var(--amber-dark);
      --row-yellow-bg:      #FEF3C7;
      --row-yellow-hover:   #FDE68A;
      --badge-red-bg:       #FEE8E6;
      --badge-red-text:     var(--alert);
      --row-red-bg:         #FEE2E2;
      --row-red-hover:      #FECACA;
    }

    [data-theme="dark"] {
      --bg-page:            #060c18;
      --bg-card:            #0b1525;
      --bg-header-main:     #071630;
      --bg-header:          #091220;
      --bg-header-hover:    #122030;
      --bg-hover:           #122030;
      --bg-editable-hover:  #162840;
      --bg-input:           #0e1a2e;
      --text-primary:       #c8d9ec;
      --text-secondary:     #5A6E82;
      --text-muted:         #344d66;
      --border-main:        #162840;
      --border-light:       #0f1e32;
      --border-input:       #1a3254;
      --shadow:             rgba(0,0,0,0.5);
      --shadow-lg:          rgba(0,0,0,0.65);
      --separator:          #1a3254;
      --link-color:         var(--amber);
      --focus-border:       var(--amber);
      --accent:             var(--amber);

      --badge-green-bg:     #010f09;
      --badge-green-text:   #10b981;
      --badge-yellow-bg:    #0c0700;
      --badge-yellow-text:  var(--amber);
      --row-yellow-bg:      #3d2800;
      --row-yellow-hover:   #4f3400;
      --badge-red-bg:       #0c0101;
      --badge-red-text:     #f87171;
      --row-red-bg:         #3d1010;
      --row-red-hover:      #4f1616;
    }

    [data-theme="dark"] {
      background-image: radial-gradient(circle, rgba(22,40,64,0.4) 1px, transparent 1px);
      background-size: 22px 22px;
    }

    body {
      font-family: 'Instrument Sans', sans-serif;
      background: var(--bg-page);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* ── App header ── */
    .app-header {
      background: var(--bg-header-main);
      border-bottom: 2px solid var(--accent);
      box-shadow: 0 2px 16px rgba(0,0,0,0.35);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .header-logo {
      max-height: 38px;
      max-width: 120px;
      object-fit: contain;
    }

    .header-title {
      font-family: 'Big Shoulders Display', sans-serif;
      font-size: 1.45rem;
      font-weight: 700;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      flex: 1;
      white-space: nowrap;
      color: #ffffff;
    }

    .header-title span {
      font-family: 'Instrument Sans', sans-serif;
      font-size: 0.68rem;
      font-weight: 400;
      color: var(--accent);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      display: block;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .header-link {
      color: rgba(200,220,240,0.8);
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: 500;
      letter-spacing: 0.03em;
      padding: 4px 8px;
      border-radius: 3px;
      transition: color 0.15s, background 0.15s;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }

    .header-link:hover {
      color: #fff;
      background: rgba(255,255,255,0.14);
    }

    /* Connection indicator */
    .connection-status {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.72rem;
      color: rgba(200,220,240,0.6);
    }

    .connection-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #e53e3e;
    }

    .connection-dot.connected {
      background: #38a169;
    }

    /* Dark mode toggle */
    .dark-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      color: rgba(200,220,240,0.7);
      user-select: none;
    }

    .dark-toggle-track {
      width: 36px;
      height: 20px;
      border-radius: 10px;
      background: rgba(255,255,255,0.18);
      position: relative;
      transition: background 0.2s;
    }

    .dark-toggle-track .thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #fff;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.2s;
    }

    [data-theme="dark"] .dark-toggle-track { background: var(--accent); }
    [data-theme="dark"] .dark-toggle-track .thumb { transform: translateX(16px); }

    /* ── Page body ── */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Summary bar */
    .summary-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 14px;
      padding: 10px 16px;
      background: var(--bg-card);
      border-radius: 6px;
      border: 1px solid var(--border-main);
      box-shadow: 0 1px 4px var(--shadow);
      font-size: 0.83rem;
      font-weight: 500;
    }

    .summary-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .summary-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      display: inline-block;
    }

    .summary-dot.green  { background: var(--success); }
    .summary-dot.yellow { background: var(--amber); }
    .summary-dot.red    { background: var(--alert); }

    .summary-separator {
      color: var(--separator);
      user-select: none;
    }

    /* Controls */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 14px;
      align-items: center;
    }

    .controls select,
    .controls input {
      padding: 7px 11px;
      border: 1px solid var(--border-input);
      border-radius: 4px;
      font-size: 0.875rem;
      font-family: 'Instrument Sans', sans-serif;
      background: var(--bg-input);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.15s;
    }

    .controls select:focus,
    .controls input:focus {
      border-color: var(--focus-border);
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--focus-border) 20%, transparent);
    }

    .controls input {
      flex: 1;
      min-width: 200px;
      max-width: 320px;
    }

    .controls select { min-width: 160px; }

    /* Bulk action bar */
    .bulk-bar {
      display: none;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px 16px;
      background: var(--amber-light);
      border: 1px solid #EDCC80;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 0.875rem;
    }

    [data-theme="dark"] .bulk-bar {
      background: #140e00;
      border-color: #3d2500;
    }

    .bulk-bar.visible { display: flex; }

    .bulk-count {
      font-weight: 700;
      color: var(--amber-dark);
      white-space: nowrap;
      min-width: 100px;
      font-family: 'Big Shoulders Display', sans-serif;
      font-size: 0.95rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    [data-theme="dark"] .bulk-count { color: var(--amber); }

    .bulk-fields {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      flex: 1;
    }

    .bulk-fields label {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-secondary);
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .bulk-fields select,
    .bulk-fields input[type="text"] {
      padding: 5px 8px;
      border: 1px solid var(--border-input);
      border-radius: 4px;
      font-size: 0.8rem;
      font-family: 'Instrument Sans', sans-serif;
      background: var(--bg-input);
      color: var(--text-primary);
    }

    .bulk-actions { display: flex; gap: 6px; flex-shrink: 0; }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 14px;
      border-radius: 4px;
      font-family: 'Instrument Sans', sans-serif;
      font-size: 0.83rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      border: none;
      transition: background 0.15s, opacity 0.15s, transform 0.1s;
    }

    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; }

    .btn-primary { background: var(--amber); color: var(--navy); }
    .btn-primary:hover:not(:disabled) { background: var(--amber-dark); color: #fff; }

    .btn-ghost {
      background: var(--bg-hover);
      color: var(--text-primary);
      border: 1px solid var(--border-main);
    }
    .btn-ghost:hover:not(:disabled) { background: var(--border-main); }

    .btn-sm { padding: 4px 10px; font-size: 0.78rem; }

    /* Table wrapper */
    .table-wrap {
      background: var(--bg-card);
      border-radius: 6px;
      border: 1px solid var(--border-main);
      box-shadow: 0 1px 4px var(--shadow);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    thead th {
      text-align: left;
      padding: 11px 14px;
      background: var(--bg-header);
      border-bottom: 2px solid var(--border-main);
      font-family: 'Big Shoulders Display', sans-serif;
      font-size: 0.82rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--navy);
      white-space: nowrap;
      user-select: none;
    }

    [data-theme="dark"] thead th { color: var(--text-secondary); }

    th.sortable { cursor: pointer; }
    th.sortable:hover { background: var(--bg-header-hover); }

    th .sort-arrow {
      margin-left: 4px;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    th .sort-arrow.active { color: var(--accent); }

    tbody td {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border-light);
      vertical-align: middle;
    }

    tbody tr:last-child td { border-bottom: none; }

    tbody tr:hover { background: var(--bg-hover); }

    tbody tr.row-yellow { background: var(--row-yellow-bg); }
    tbody tr.row-yellow:hover { background: var(--row-yellow-hover); }

    tbody tr.row-red { background: var(--row-red-bg); }
    tbody tr.row-red:hover { background: var(--row-red-hover); }

    /* Status badge */
    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 9999px;
      font-size: 0.78rem;
      font-weight: 600;
      white-space: nowrap;
      letter-spacing: 0.02em;
    }

    .badge.green  { background: var(--badge-green-bg);  color: var(--badge-green-text); }
    .badge.yellow { background: var(--badge-yellow-bg); color: var(--badge-yellow-text); }
    .badge.red    { background: var(--badge-red-bg);    color: var(--badge-red-text); }

    /* Editable cells */
    .editable {
      cursor: pointer;
      border-radius: 3px;
      padding: 2px 5px;
      min-height: 1.5em;
      transition: background 0.15s;
    }

    .editable:hover { background: var(--bg-editable-hover); }

    .editable.empty {
      color: var(--text-muted);
      font-style: italic;
    }

    /* Inline edit inputs */
    td input[type="text"],
    td select {
      width: 100%;
      padding: 4px 8px;
      border: 2px solid var(--focus-border);
      border-radius: 4px;
      font-size: 0.875rem;
      font-family: 'Instrument Sans', sans-serif;
      outline: none;
      background: var(--bg-input);
      color: var(--text-primary);
    }

    td select { cursor: pointer; }

    td select optgroup {
      font-weight: 700;
      font-style: normal;
      color: var(--text-secondary);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    td select option {
      font-weight: 500;
      font-size: 0.875rem;
      padding: 4px 8px;
      color: var(--text-primary);
    }

    /* Timestamp */
    .timestamp {
      color: var(--text-secondary);
      font-size: 0.78rem;
      white-space: nowrap;
    }

    /* Checkbox column */
    .col-check {
      width: 40px;
      padding: 8px 4px 8px 14px !important;
    }

    thead .col-check { padding: 11px 4px 11px 14px !important; }

    .col-check input[type="checkbox"] {
      width: 15px;
      height: 15px;
      cursor: pointer;
      accent-color: var(--amber);
      vertical-align: middle;
    }

    /* Selected row highlight */
    tbody tr.row-selected {
      box-shadow: inset 4px 0 0 var(--amber);
    }

    /* Footer */
    .page-footer {
      text-align: center;
      padding: 24px 0 12px;
      font-size: 0.72rem;
      color: var(--text-muted);
      letter-spacing: 0.04em;
    }

    /* Mobile */
    @media (max-width: 768px) {
      .container { padding: 12px; }
      table { font-size: 0.8rem; }
      thead th, tbody td { padding: 8px 8px; }
      .controls { gap: 8px; }
      .controls input { max-width: 100%; min-width: 0; }
      .col-vehicle,
      .col-estimated-return,
      .col-last-changed { display: none; }
      .header-title { font-size: 1.15rem; }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="header-inner">
      <img src="/images/logo.png" alt="CCPPD Logo" class="header-logo" onerror="this.style.display='none'">
      <div class="header-title">
        In/Out Board
        <span>Cuming County Public Power District</span>
      </div>
      <div class="header-actions">
        <label class="dark-toggle" id="darkToggle">
          <span class="dark-toggle-track"><span class="thumb"></span></span>
          <span>Dark</span>
        </label>
        <a href="/admin.html" class="header-link">Admin</a>
        <span class="connection-status">
          <span class="connection-dot" id="connDot"></span>
          <span id="connLabel">Connecting...</span>
        </span>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="summary-bar" id="summaryBar"></div>

    <div class="controls">
      <select id="deptFilter">
        <option value="">All Departments</option>
      </select>
      <input type="text" id="nameSearch" placeholder="Search by name...">
    </div>

    <div class="bulk-bar" id="bulkBar">
      <span class="bulk-count" id="bulkCount"></span>
      <div class="bulk-fields">
        <label for="bulkStatus">Status:</label>
        <select id="bulkStatus"><option value="">(no change)</option></select>
        <label for="bulkVehicle">Vehicle:</label>
        <select id="bulkVehicle"><option value="NOCHANGE">(no change)</option><option value="">(None)</option></select>
        <label for="bulkComment">Comment:</label>
        <input type="text" id="bulkComment" placeholder="(no change)" style="min-width:140px;" maxlength="500">
        <label for="bulkReturn">Est. Return:</label>
        <input type="text" id="bulkReturn" placeholder="(no change)" style="min-width:110px;" maxlength="100">
      </div>
      <div class="bulk-actions">
        <button id="bulkApply" class="btn btn-primary btn-sm">Apply</button>
        <button id="bulkClear" class="btn btn-ghost btn-sm">Clear</button>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="col-check"><input type="checkbox" id="selectAll" title="Select/deselect all visible"></th>
            <th class="sortable" data-sort="name">Name <span class="sort-arrow" id="arrow-name">&#9650;</span></th>
            <th class="sortable" data-sort="department">Department <span class="sort-arrow" id="arrow-department"></span></th>
            <th class="sortable" data-sort="status">Status <span class="sort-arrow" id="arrow-status"></span></th>
            <th>Comment</th>
            <th class="col-vehicle">Vehicle</th>
            <th class="col-estimated-return">Est. Return</th>
            <th class="col-last-changed">Last Changed</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <footer class="page-footer">In/Out Board v<span id="footerVersion"></span></footer>

  <script>
    // --- Constants ---
    const GREEN_STATUSES = ['IN'];
    const YELLOW_STATUSES = ['In Meeting', 'On Break', 'At Lunch', 'Away from Desk'];
    const RED_STATUSES = ['OUT', 'Working Remotely', 'PTO', 'Sick'];
    const ALL_STATUSES = [...GREEN_STATUSES, ...YELLOW_STATUSES, ...RED_STATUSES];

    function statusColor(status) {
      if (GREEN_STATUSES.includes(status)) return 'green';
      if (YELLOW_STATUSES.includes(status)) return 'yellow';
      return 'red';
    }

    // --- Helpers ---
    function sortVehicles(a, b) {
      const aTruck = /^T\d/i.test(a.name);
      const bTruck = /^T\d/i.test(b.name);
      if (aTruck !== bTruck) return aTruck ? 1 : -1;
      if (aTruck) return parseInt(a.name.slice(1)) - parseInt(b.name.slice(1));
      return a.name.localeCompare(b.name);
    }

    // --- State ---
    let employees = [];
    let vehicles = [];
    let departments = [];
    let selectedIds = new Set();
    let sortCol = 'name';
    let sortAsc = true;
    let ws = null;

    // --- DOM refs ---
    const tableBody = document.getElementById('tableBody');
    const summaryBar = document.getElementById('summaryBar');
    const deptFilter = document.getElementById('deptFilter');
    const nameSearch = document.getElementById('nameSearch');
    const connDot = document.getElementById('connDot');
    const connLabel = document.getElementById('connLabel');
    const darkToggle = document.getElementById('darkToggle');
    const bulkBar = document.getElementById('bulkBar');
    const bulkCount = document.getElementById('bulkCount');
    const bulkStatus = document.getElementById('bulkStatus');
    const bulkComment = document.getElementById('bulkComment');
    const bulkVehicle = document.getElementById('bulkVehicle');
    const bulkReturn = document.getElementById('bulkReturn');
    const bulkApply = document.getElementById('bulkApply');
    const bulkClear = document.getElementById('bulkClear');
    const selectAll = document.getElementById('selectAll');

    // --- Dark mode ---
    function applyTheme(dark) {
      document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
      localStorage.setItem('theme', dark ? 'dark' : 'light');
    }

    darkToggle.addEventListener('click', () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      applyTheme(!isDark);
    });

    // Initialize from saved preference or system preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      applyTheme(savedTheme === 'dark');
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      applyTheme(true);
    }

    // --- WebSocket ---
    function connectWs() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}`);

      ws.addEventListener('open', () => {
        connDot.classList.add('connected');
        connLabel.textContent = 'Connected';
      });

      ws.addEventListener('close', () => {
        connDot.classList.remove('connected');
        connLabel.textContent = 'Disconnected — reconnecting...';
        setTimeout(connectWs, 2000);
      });

      ws.addEventListener('message', (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'init') {
          employees = data.employees;
          vehicles = data.vehicles || [];
          departments = data.departments || [];
          selectedIds.clear();
          refreshDeptFilter();
          render();
        } else if (data.type === 'department_added') {
          departments.push(data.department);
          departments.sort((a, b) => a.name.localeCompare(b.name));
        } else if (data.type === 'department_updated') {
          const idx = departments.findIndex(d => d.id === data.department.id);
          if (idx !== -1) departments[idx] = data.department;
        } else if (data.type === 'department_removed') {
          departments = departments.filter(d => d.id !== data.id);
        } else if (data.type === 'employee_updated') {
          const idx = employees.findIndex(e => e.id === data.employee.id);
          if (idx !== -1) {
            employees[idx] = data.employee;
          }
          refreshDeptFilter();
          render();
        } else if (data.type === 'employee_added') {
          employees.push(data.employee);
          employees.sort((a, b) => a.name.localeCompare(b.name));
          refreshDeptFilter();
          render();
        } else if (data.type === 'employee_removed') {
          employees = employees.filter(e => e.id !== data.id);
          refreshDeptFilter();
          render();
        } else if (data.type === 'vehicle_added') {
          vehicles.push(data.vehicle);
          vehicles.sort(sortVehicles);
          render();
        } else if (data.type === 'vehicle_updated') {
          const idx = vehicles.findIndex(v => v.id === data.vehicle.id);
          if (idx !== -1) vehicles[idx] = data.vehicle;
          render();
        } else if (data.type === 'vehicle_removed') {
          vehicles = vehicles.filter(v => v.id !== data.id);
          render();
        }
      });
    }

    connectWs();

    // --- API helper ---
    async function updateEmployee(id, fields) {
      const res = await fetch(`/employees/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(fields),
      });
      if (!res.ok) {
        console.error('Update failed', await res.text());
      }
    }

    // --- Filtering & sorting ---
    function getFilteredSorted() {
      let list = [...employees];

      const dept = deptFilter.value;
      if (dept) {
        list = list.filter(e => e.department === dept);
      }

      const search = nameSearch.value.trim().toLowerCase();
      if (search) {
        list = list.filter(e => e.name.toLowerCase().includes(search));
      }

      list.sort((a, b) => {
        let cmp;
        if (sortCol === 'status') {
          cmp = ALL_STATUSES.indexOf(a.status) - ALL_STATUSES.indexOf(b.status);
        } else {
          const aVal = (a[sortCol] || '').toLowerCase();
          const bVal = (b[sortCol] || '').toLowerCase();
          cmp = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
        }
        return sortAsc ? cmp : -cmp;
      });

      return list;
    }

    // --- Department filter ---
    function refreshDeptFilter() {
      const current = deptFilter.value;
      const depts = [...new Set(employees.map(e => e.department))].sort();
      deptFilter.innerHTML = '<option value="">All Departments</option>';
      depts.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        if (d === current) opt.selected = true;
        deptFilter.appendChild(opt);
      });
    }

    deptFilter.addEventListener('change', render);
    nameSearch.addEventListener('input', render);

    // --- Sorting ---
    document.querySelectorAll('th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.sort;
        if (sortCol === col) {
          sortAsc = !sortAsc;
        } else {
          sortCol = col;
          sortAsc = true;
        }
        updateSortArrows();
        render();
      });
    });

    function updateSortArrows() {
      document.querySelectorAll('.sort-arrow').forEach(el => {
        el.classList.remove('active');
        el.innerHTML = '';
      });
      const arrow = document.getElementById(`arrow-${sortCol}`);
      if (arrow) {
        arrow.classList.add('active');
        arrow.innerHTML = sortAsc ? '&#9650;' : '&#9660;';
      }
    }

    // --- Summary bar ---
    function renderSummary() {
      const counts = {};
      ALL_STATUSES.forEach(s => counts[s] = 0);
      employees.forEach(e => {
        if (counts[e.status] !== undefined) counts[e.status]++;
      });

      const items = [];
      ALL_STATUSES.forEach(s => {
        if (counts[s] > 0) {
          const color = statusColor(s);
          items.push(`<span class="summary-item"><span class="summary-dot ${color}"></span>${counts[s]} ${s}</span>`);
        }
      });

      summaryBar.innerHTML = items.join('<span class="summary-separator">&middot;</span>');
    }

    // --- Format timestamp ---
    function formatAbsoluteTimestamp(ts) {
      if (!ts) return '';
      const d = new Date(ts + 'Z');
      return d.toLocaleString(undefined, {
        month: 'short', day: 'numeric',
        hour: 'numeric', minute: '2-digit',
      });
    }

    function formatRelativeTimestamp(ts) {
      if (!ts) return '';
      const d = new Date(ts + 'Z');
      const now = new Date();
      const diffMs = now - d;
      const diffMin = Math.floor(diffMs / 60000);
      const diffHrs = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMin < 1) return 'Just now';
      if (diffMin < 60) return `${diffMin} min ago`;
      if (diffHrs < 24) return `${diffHrs} hr${diffHrs > 1 ? 's' : ''} ago`;
      return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    }

    // --- Render table ---
    function render() {
      renderSummary();
      const list = getFilteredSorted();

      tableBody.innerHTML = '';
      list.forEach(emp => {
        const tr = document.createElement('tr');
        const color = statusColor(emp.status);
        if (color === 'yellow') tr.classList.add('row-yellow');
        if (color === 'red') tr.classList.add('row-red');
        if (selectedIds.has(emp.id)) tr.classList.add('row-selected');

        if (emp.status !== 'IN') {
          tr.title = 'Double-click to mark IN';
          tr.addEventListener('dblclick', () => {
            updateEmployee(emp.id, { status: 'IN' });
            emp.status = 'IN';
            emp.comment = '';
            emp.estimated_return = '';
            emp.vehicle_id = null;
            emp.vehicle_name = '';
            render();
          });
        }

        // Checkbox
        const tdCheck = document.createElement('td');
        tdCheck.className = 'col-check';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = selectedIds.has(emp.id);
        cb.addEventListener('change', () => {
          if (cb.checked) selectedIds.add(emp.id);
          else selectedIds.delete(emp.id);
          tr.classList.toggle('row-selected', cb.checked);
          updateBulkBar();
        });
        tdCheck.addEventListener('dblclick', e => e.stopPropagation());
        tdCheck.appendChild(cb);
        tr.appendChild(tdCheck);

        // Name
        const tdName = document.createElement('td');
        tdName.textContent = emp.name;
        tr.appendChild(tdName);

        // Department
        const tdDept = document.createElement('td');
        tdDept.textContent = emp.department;
        tr.appendChild(tdDept);

        // Status (editable dropdown)
        const tdStatus = document.createElement('td');
        const badge = document.createElement('span');
        badge.className = `badge ${color} editable`;
        badge.textContent = emp.status;
        badge.addEventListener('click', () => openStatusEditor(tdStatus, emp));
        tdStatus.appendChild(badge);
        tr.appendChild(tdStatus);

        // Comment (editable)
        const tdComment = document.createElement('td');
        const commentSpan = document.createElement('span');
        commentSpan.className = 'editable' + (emp.comment ? '' : ' empty');
        commentSpan.textContent = emp.comment || 'Add comment...';
        commentSpan.addEventListener('click', () => openTextEditor(tdComment, emp, 'comment', 'Add comment...'));
        tdComment.appendChild(commentSpan);
        tr.appendChild(tdComment);

        // Vehicle (editable dropdown)
        const tdVehicle = document.createElement('td');
        tdVehicle.className = 'col-vehicle';
        const vehicleSpan = document.createElement('span');
        vehicleSpan.className = 'editable' + (emp.vehicle_name ? '' : ' empty');
        vehicleSpan.textContent = emp.vehicle_name || 'None';
        vehicleSpan.addEventListener('click', () => openVehicleEditor(tdVehicle, emp));
        tdVehicle.appendChild(vehicleSpan);
        tr.appendChild(tdVehicle);

        // Estimated Return (editable)
        const tdReturn = document.createElement('td');
        tdReturn.className = 'col-estimated-return';
        const returnSpan = document.createElement('span');
        returnSpan.className = 'editable' + (emp.estimated_return ? '' : ' empty');
        returnSpan.textContent = emp.estimated_return || 'Set return...';
        returnSpan.addEventListener('click', () => openTextEditor(tdReturn, emp, 'estimated_return', 'Set return...'));
        tdReturn.appendChild(returnSpan);
        tr.appendChild(tdReturn);

        // Last Changed
        const tdChanged = document.createElement('td');
        tdChanged.className = 'col-last-changed';
        const tsSpan = document.createElement('span');
        tsSpan.className = 'timestamp';
        tsSpan.textContent = formatRelativeTimestamp(emp.last_changed);
        tsSpan.title = formatAbsoluteTimestamp(emp.last_changed);
        tdChanged.appendChild(tsSpan);
        tr.appendChild(tdChanged);

        tableBody.appendChild(tr);
      });

      updateBulkBar();
    }

    // --- Inline editors ---
    const STATUS_GROUPS = [
      { label: 'Available', statuses: GREEN_STATUSES },
      { label: 'Unavailable', statuses: YELLOW_STATUSES },
      { label: 'Out of Office', statuses: RED_STATUSES },
    ];

    // Populate bulk status dropdown from STATUS_GROUPS
    STATUS_GROUPS.forEach(group => {
      const og = document.createElement('optgroup');
      og.label = group.label;
      group.statuses.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        og.appendChild(opt);
      });
      bulkStatus.appendChild(og);
    });

    // --- Bulk selection ---
    function updateBulkBar() {
      const visible = getFilteredSorted();
      const visibleSelected = visible.filter(e => selectedIds.has(e.id));
      const total = selectedIds.size;

      if (total > 0) {
        bulkBar.classList.add('visible');
        bulkCount.textContent = `${total} selected`;
      } else {
        bulkBar.classList.remove('visible');
      }

      const allVisible = visible.length > 0 && visible.every(e => selectedIds.has(e.id));
      const someVisible = visibleSelected.length > 0;
      selectAll.checked = allVisible;
      selectAll.indeterminate = !allVisible && someVisible;

      // Rebuild vehicle options, preserving current selection
      const prevVehicle = bulkVehicle.value;
      bulkVehicle.innerHTML = '<option value="NOCHANGE">(no change)</option><option value="">(None)</option>';
      vehicles.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.id;
        opt.textContent = v.name;
        bulkVehicle.appendChild(opt);
      });
      if ([...bulkVehicle.options].some(o => o.value === prevVehicle)) {
        bulkVehicle.value = prevVehicle;
      }
    }

    selectAll.addEventListener('change', () => {
      getFilteredSorted().forEach(e => {
        if (selectAll.checked) selectedIds.add(e.id);
        else selectedIds.delete(e.id);
      });
      render();
    });

    bulkClear.addEventListener('click', () => {
      selectedIds.clear();
      bulkStatus.value = '';
      bulkVehicle.value = 'NOCHANGE';
      bulkComment.value = '';
      bulkReturn.value = '';
      render();
    });

    bulkApply.addEventListener('click', () => {
      if (selectedIds.size === 0) return;
      const statusVal = bulkStatus.value;
      const vehicleVal = bulkVehicle.value; // 'NOCHANGE' | '' | '<id>'
      const commentVal = bulkComment.value.trim();
      const returnVal = bulkReturn.value.trim();
      if (!statusVal && vehicleVal === 'NOCHANGE' && !commentVal && !returnVal) return;

      bulkApply.disabled = true;
      selectedIds.forEach(id => {
        const emp = employees.find(e => e.id === id);
        if (!emp) return;
        const fields = {};
        if (statusVal) fields.status = statusVal;
        // Vehicle: skip if setting status=IN (server clears it anyway)
        if (vehicleVal !== 'NOCHANGE' && statusVal !== 'IN') {
          const vehicleId = vehicleVal === '' ? null : Number(vehicleVal);
          fields.vehicle_id = vehicleId;
          // Auto-OUT if assigning a vehicle to someone currently IN
          if (vehicleId && emp.status === 'IN' && !statusVal) {
            fields.status = 'OUT';
          }
        }
        if (commentVal) fields.comment = commentVal;
        if (returnVal) fields.estimated_return = returnVal;
        if (Object.keys(fields).length === 0) return;

        // Optimistic update
        if (fields.status === 'IN') {
          emp.status = 'IN';
          emp.comment = '';
          emp.estimated_return = '';
          emp.vehicle_id = null;
          emp.vehicle_name = '';
        } else {
          if (fields.status) emp.status = fields.status;
          if (fields.vehicle_id !== undefined) {
            emp.vehicle_id = fields.vehicle_id;
            emp.vehicle_name = fields.vehicle_id
              ? (vehicles.find(v => v.id === fields.vehicle_id) || {}).name || ''
              : '';
          }
          if (fields.comment !== undefined) emp.comment = fields.comment;
          if (fields.estimated_return !== undefined) emp.estimated_return = fields.estimated_return;
        }
        updateEmployee(id, fields);
      });

      bulkStatus.value = '';
      bulkVehicle.value = 'NOCHANGE';
      bulkComment.value = '';
      bulkReturn.value = '';
      selectedIds.clear();
      bulkApply.disabled = false;
      render();
    });

    function openStatusEditor(td, emp) {
      td.innerHTML = '';
      const sel = document.createElement('select');

      STATUS_GROUPS.forEach(group => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = group.label;
        group.statuses.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          if (s === emp.status) opt.selected = true;
          optgroup.appendChild(opt);
        });
        sel.appendChild(optgroup);
      });

      sel.addEventListener('change', () => {
        updateEmployee(emp.id, { status: sel.value });
        // Optimistic local update
        emp.status = sel.value;
        if (sel.value === 'IN') {
          emp.comment = '';
          emp.estimated_return = '';
          emp.vehicle_id = null;
          emp.vehicle_name = '';
        }
        render();
      });

      sel.addEventListener('blur', () => render());

      td.appendChild(sel);
      sel.focus();
    }

    function openVehicleEditor(td, emp) {
      td.innerHTML = '';
      const sel = document.createElement('select');

      const noneOpt = document.createElement('option');
      noneOpt.value = '';
      noneOpt.textContent = '(None)';
      if (!emp.vehicle_id) noneOpt.selected = true;
      sel.appendChild(noneOpt);

      vehicles.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.id;
        const takenBy = employees.find(e => e.vehicle_id === v.id && e.id !== emp.id);
        if (takenBy) {
          opt.textContent = `${v.name} — taken by ${takenBy.name}`;
          opt.disabled = true;
        } else {
          opt.textContent = v.name;
        }
        if (v.id === emp.vehicle_id) opt.selected = true;
        sel.appendChild(opt);
      });

      sel.addEventListener('change', () => {
        const vehicleId = sel.value ? Number(sel.value) : null;
        const fields = { vehicle_id: vehicleId };
        // Auto-set status to OUT when picking a vehicle while IN
        if (vehicleId && emp.status === 'IN') {
          fields.status = 'OUT';
        }
        updateEmployee(emp.id, fields);
        emp.vehicle_id = vehicleId;
        emp.vehicle_name = vehicleId ? (vehicles.find(v => v.id === vehicleId) || {}).name || '' : '';
        if (fields.status) emp.status = fields.status;
        render();
      });

      sel.addEventListener('blur', () => render());

      td.appendChild(sel);
      sel.focus();
    }

    const FIELD_MAXLEN = { name: 100, department: 100, comment: 500, estimated_return: 100 };
    function openTextEditor(td, emp, field, placeholder) {
      td.innerHTML = '';
      const input = document.createElement('input');
      input.type = 'text';
      input.value = emp[field] || '';
      input.placeholder = placeholder;
      if (FIELD_MAXLEN[field]) input.maxLength = FIELD_MAXLEN[field];

      function save() {
        const val = input.value.trim();
        if (val !== (emp[field] || '')) {
          updateEmployee(emp.id, { [field]: val });
          emp[field] = val;
        }
        render();
      }

      input.addEventListener('blur', save);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          save();
        }
        if (e.key === 'Escape') {
          render();
        }
      });

      td.appendChild(input);
      input.focus();
      input.select();
    }

    // Initialize arrows
    updateSortArrows();

    // Refresh relative timestamps every 60 seconds
    setInterval(render, 60000);

    // --- Footer version ---
    fetch('/version').then(r => r.json()).then(({ version }) => {
      document.getElementById('footerVersion').textContent = version;
    });
  </script>
</body>
</html>
